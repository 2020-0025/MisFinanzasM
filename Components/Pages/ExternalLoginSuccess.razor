@page "/external-login-success"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using MisFinanzas.Services
@using MisFinanzas.Components.Layout
@layout MinimalLayout
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>Finalizando autenticación...</PageTitle>

<div class="auth-container">
    <div class="auth-card animate-slide-up">
        <div class="auth-header">
            <h2>✅ Autenticación exitosa</h2>
            <p class="text-white">@statusMessage</p>
        </div>

        <div class="text-center">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="text-white mt-3">Redirigiendo al Dashboard...</p>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? UserId { get; set; }

    [SupplyParameterFromQuery]
    public string? UserName { get; set; }

    [SupplyParameterFromQuery]
    public string? UserRole { get; set; }

    private string statusMessage = "Sincronizando sesión...";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SyncSessionStorage();
        }
    }

    private async Task SyncSessionStorage()
    {
        try
        {
            if (string.IsNullOrEmpty(UserId) || string.IsNullOrEmpty(UserName))
            {
                Console.WriteLine("❌ Missing user parameters");
                NavigationManager.NavigateTo("/login");
                return;
            }

            Console.WriteLine($"🔄 Syncing SessionStorage for {UserName}...");

            // Sincronizar con SessionStorage usando AuthService
            var loginSuccess = await AuthService.LoginAsync(UserId, UserName, UserRole ?? "User");

            if (!loginSuccess)
            {
                Console.WriteLine("❌ Failed to sync with SessionStorage");
                statusMessage = "Error al sincronizar sesión...";
                StateHasChanged();
                await Task.Delay(2000);
                NavigationManager.NavigateTo("/login");
                return;
            }

            Console.WriteLine($"✅ SessionStorage synced successfully");

            statusMessage = "¡Listo! Redirigiendo...";
            StateHasChanged();
            await Task.Delay(1000);

            // Redirigir al Dashboard
            NavigationManager.NavigateTo("/dashboard", true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error syncing SessionStorage: {ex.Message}");
            NavigationManager.NavigateTo("/login");
        }
    }
}